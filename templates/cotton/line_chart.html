{% load custom_filters %}
{% comment %} 
Cotton Component: Line Chart
This component creates a responsive line chart using Chart.js, Alpine.js, and Django Cotton.
It allows for customization of chart data, labels, and appearance.
{% endcomment %}

{% comment %} c-vars is how you can default values for a Cotton component {% endcomment %}
<c-vars 
    :index="[]"
    :series="[]" 
    :series_labels="[]" 
    chart_id="myChart" 
    chart_title="" 
    x_label="" 
    y_label="" 
    x_unit="" 
    y_unit="" 
    colors="['rgb(75, 192, 192)']" 
/>

<div x-data="lineChart(
        '{{ chart_id }}', 
        {{ index|safe }}, 
        {{ series|safe }}, 
        {{ series_labels|safe }}, 
        '{{ chart_title }}', 
        '{{ x_label }}', 
        '{{ y_label }}', 
        '{{ x_unit }}', 
        '{{ y_unit }}', 
        {{ colors|safe }})"
     x-init="createChartIfNotExists"
     class="w-full h-full"
     {{ attrs }}>
     {% comment %} Canvas element where Chart.js will render the chart {% endcomment %}
    <canvas x-ref="canvas" class="w-full h-full"></canvas>
</div>

<script>
    {% comment %} Initialize Alpine.js component when the DOM is ready {% endcomment %}
  document.addEventListener('alpine:init', () => {
    Alpine.data('lineChart', (chartId, index, series, seriesLabels, chartTitle, xLabel, yLabel, xUnit, yUnit, colors) => ({
      chartId,
      chart: null,
  
      createChartIfNotExists() {
        // nextTick is used to ensure that the chart is created after the DOM is fully rendered
        this.$nextTick(() => {
            if (!this.chart) {
                const ctx = this.$refs.canvas;
                this.chart = new Chart(ctx, this.getChartConfig());
            }
        });
      },
  
      getChartConfig() {
        return {
          type: 'line',
          data: {
            labels: index, // X-axis values
            datasets: series.map((data, i) => ({
              label: seriesLabels[i],
              data: data,
              borderColor: colors[i],
              tension: 0.1 // Slight curve in the line
            }))
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: chartTitle
              }
            },
            scales: {
              x: {
                title: {
                  display: true,
                  text: `${xLabel}${xUnit ? ` (${xUnit})` : ''}` // Add unit to X-axis label if provided
                }
              },
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: `${yLabel}${yUnit ? ` (${yUnit})` : ''}` // Add unit to Y-axis label if provided
                }
              }
            }
          }
        };
      }
    }));
  });
</script>
