{% load custom_filters %}

<c-vars 
    :index="[]" 
    :series="[]" 
    :series_labels="[]" 
    chart_id="myChart" 
    chart_title="" 
    x_label="" 
    y_label="" 
    x_unit="" 
    y_unit="" 
    :colors="['rgb(75, 192, 192)']" 
/>

<canvas id="{{ chart_id }}"></canvas>

<script>
    (function() {
        // Construct a new Chart.js instance with the given component configuration
        function constructChartInstance() {
            try {
                const ctx = document.getElementById('{{ chart_id }}').getContext('2d');
                const myChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: {{ index|safe }},
                        datasets: [
                            {% for serie in series %}
                            {
                                label: '{{ series_labels|get_item:forloop.counter0 }}',
                                data: {{ serie|safe }},
                                borderColor: '{{ colors|get_item:forloop.counter0 }}',
                                tension: 0.1
                            }{% if not forloop.last %},{% endif %}
                            {% endfor %}
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: '{{ chart_title }}'
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: '{{ x_label }}{% if x_unit %} ({{ x_unit }}){% endif %}'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '{{ y_label }}{% if y_unit %} ({{ y_unit }}){% endif %}'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error constructing chart:', error);
            }
        }

        // create the chart if it doesn't exist yet
        function createChartIfNeeded() {
            const chartElement = document.getElementById('{{ chart_id }}');
            if (chartElement) {
                const existingChart = Chart.getChart('{{ chart_id }}');
                if (!existingChart) {
                    constructChartInstance();
                }
            }
        }

        // If DOM is ready, create the chart. Else wait for DOM to be ready before creating the chart.
        function createChartOnDOMState() {
            if (document.readyState === 'loading') {
                // If the DOM is still loading, wait for it to be ready before creating the chart
                document.addEventListener('DOMContentLoaded', createChartIfNeeded);
            } else {
                // If the DOM is already loaded, (re)create the chart immediately
                createChartIfNeeded();
            }
        }

        // Set up initialization
        createChartOnDOMState();
    })();
</script>
